<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>두근두근 발표자 뽑기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
  <style>
    :root{
      --bg-main:#FFFBF5;--bg-display:#FCEFEF;--bg-celebrate:#FFF2A1;
      --color-start:#4A90E2;--color-stop:#FF6B6B;--color-feature:#4ECDC4;
      --text-default:#333;--text-winner:#FF6B6B
    }
    body{font-family:'Gowun Dodum',sans-serif;background:var(--bg-main)}
    .result-display{font-weight:900;font-size:12rem;line-height:1;text-shadow:4px 4px 10px rgba(0,0,0,.08);color:var(--text-default);transition:color .3s}
    .characteristic-display{font-weight:700;font-size:2.5rem;line-height:1.4;text-shadow:2px 2px 6px rgba(0,0,0,.08);color:var(--text-default);transition:color .3s;word-break:keep-all}
    .winner{color:var(--text-winner)!important}
    .btn-primary{transition:.2s;box-shadow:0 4px 14px rgba(0,0,0,.1);border:none}
    .btn-primary:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.15)}
    .btn-primary:disabled{opacity:.7;cursor:not-allowed}
    @media (min-width:640px){.result-display{font-size:15rem}.characteristic-display{font-size:2.8rem}}
  </style>
</head>
<body class="text-slate-800 flex flex-col items-center justify-center min-h-screen p-4 antialiased">
  <div class="absolute top-4 right-4 text-xs text-slate-400">보라쌤과 역사를 보라</div>

  <div class="w-full max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl shadow-rose-100 p-6 md:p-10 text-center">
    <h1 class="text-3xl sm:text-4xl font-bold text-slate-700 mb-2 whitespace-nowrap">두근두근 발표자 뽑기</h1>
    <p class="text-slate-500 mb-6">오늘의 행운의 주인공은 누구일까요?</p>

    <div id="display-area" class="rounded-2xl min-h-[300px] md:min-h-[350px] flex items-center justify-center my-6 p-4"
         style="background-color: var(--bg-display); transition: background-color .1s ease;">
      <div id="result" class="result-display select-none">?</div>
      <div id="characteristic-result" class="characteristic-display select-none hidden px-4"></div>
    </div>

    <div>
      <div class="flex justify-center border-b border-rose-100 mb-6">
        <button id="tab-number" class="px-6 py-3 font-bold border-b-2 transition-colors">번호</button>
        <button id="tab-characteristic" class="px-6 py-3 font-bold text-slate-400 transition-colors">특징</button>
      </div>

      <div id="number-picker-controls">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
          <div class="relative w-full sm:w-auto">
            <label for="student-count" class="absolute -top-2 left-2 inline-block bg-white px-1 text-xs font-medium text-slate-500">총 학생 수</label>
            <input type="number" id="student-count" min="1" class="w-full sm:w-48 text-center text-lg px-4 py-3 rounded-xl border border-slate-300 focus:ring-2"
                   style="--tw-ring-color: var(--color-start); border-color: var(--color-start);">
          </div>
          <button id="start-btn" class="w-full sm:w-auto text-lg font-bold text-white px-8 py-3 rounded-xl btn-primary" style="background-color: var(--color-start);">시작</button>
          <button id="stop-btn" class="w-full sm:w-auto text-lg font-bold text-white px-8 py-3 rounded-xl btn-primary" style="background-color: var(--color-stop);" disabled>멈춤!</button>
        </div>
        <p id="error-msg" class="text-red-500 h-6 mt-2 text-sm"></p>
      </div>

      <div id="characteristic-picker-controls" class="hidden">
        <button id="pick-characteristic-btn" class="w-full sm:w-auto text-lg font-bold text-white px-10 py-4 rounded-xl btn-primary"
                style="background-color: var(--color-feature);">다시 뽑기!</button>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // ===== DOM refs =====
    const resultDiv = document.getElementById('result');
    const studentCountInput = document.getElementById('student-count');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const errorMsg = document.getElementById('error-msg');
    const displayArea = document.getElementById('display-area');
    const characteristicResultDiv = document.getElementById('characteristic-result');
    const pickCharacteristicBtn = document.getElementById('pick-characteristic-btn');
    const tabs = { number: document.getElementById('tab-number'), characteristic: document.getElementById('tab-characteristic') };
    const controls = { number: document.getElementById('number-picker-controls'), characteristic: document.getElementById('characteristic-picker-controls') };
    const displays = { number: resultDiv, characteristic: characteristicResultDiv };

    // ===== state =====
    let intervalId = null, celebrateIntervalId = null, isSpinning = false;
    let audioInitialized = false;
    let engine = null;          // 'tone' | 'web' | 'html'
    // Tone chain
    let poly = null;            // Tone.PolySynth
    let lead = null;            // Tone.Synth (lead)
    let rev = null, chorus = null; // effects
    // WebAudio fallback
    let webCtx = null, webGain = null;

    // URL 옵션: ?auto=1 → 언락 직후 자동 "시작"
    const params = new URLSearchParams(location.search);
    const AUTO_START = params.get('auto') === '1';

    // HTMLAudio 폴백용 초미니 비프 wav (data URI)
    const beepData = "data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAACABAAZGF0YQgAAAABAQEBBQQGBwgICQkKCwsMDQ4PEBESExQVFhcY";
    const audioEl = new Audio(beepData); audioEl.preload = "auto"; audioEl.playsInline = true;

    // ===== Audio Init: triple fallback =====
    async function initAudio() {
      if (audioInitialized) return true;

      // 1) Tone.js
      try {
        if (typeof Tone !== 'undefined') {
          await Tone.start();
          await Tone.context.resume();

          // Effects
          rev = new Tone.Reverb({ decay: 2.2, wet: 0.25 });
          chorus = new Tone.Chorus({ frequency: 4, delayTime: 2.5, depth: 0.3, wet: 0.2 }).start();

          // Instruments
          poly = new Tone.PolySynth(Tone.Synth, {
            oscillator:{ type:'triangle8' },
            envelope:{ attack:0.005, decay:0.2, sustain:0.3, release:0.9 }
          });
          lead = new Tone.Synth({
            oscillator:{ type:'sawtooth' },
            envelope:{ attack:0.005, decay:0.15, sustain:0.2, release:0.4 }
          });

          // Routing
          poly.connect(chorus);
          chorus.connect(rev);
          rev.toDestination();
          lead.connect(rev);

          engine = 'tone';
          audioInitialized = true;
          return true;
        }
      } catch (e) {
        console.warn('Tone init failed:', e);
      }

      // 2) WebAudio Oscillator
      try {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) throw new Error('AudioContext not supported');
        webCtx = new Ctx();
        if (webCtx.state !== 'running') await webCtx.resume();
        webGain = webCtx.createGain();
        webGain.gain.value = 0.25;
        webGain.connect(webCtx.destination);
        engine = 'web';
        audioInitialized = true;
        return true;
      } catch (e) {
        console.warn('WebAudio init failed:', e);
      }

      // 3) HTMLAudio
      try {
        await audioEl.play().then(()=>audioEl.pause()).catch(()=>{});
        engine = 'html';
        audioInitialized = true;
        return true;
      } catch(e) {
        console.error('HTMLAudio init failed', e);
        return false;
      }
    }

    // === WebAudio helper ===
    function webBeep(freq=523.25, dur=0.15, when=0){
      if (!webCtx||!webGain) return;
      const t0 = webCtx.currentTime + when;
      const osc = webCtx.createOscillator();
      const g = webCtx.createGain();
      osc.type='sine'; osc.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(0.6, t0+0.01);
      g.gain.linearRampToValueAtTime(0.0, t0+dur);
      osc.connect(g); g.connect(webGain);
      osc.start(t0); osc.stop(t0+dur+0.02);
    }
    async function playHtmlBeepOnce(){ try { audioEl.currentTime = 0; await audioEl.play(); } catch(e) {} }

    // ====== 멜로디(팬파레) ======
    // Tone.js: 화려한 팬파레 (아르페지오 + 마감 코드 + 글리산도 느낌)
    function playWinnerFanfare(){
      if (!audioInitialized) return;

      if (engine === 'tone' && poly && lead){
        const t = Tone.now();

        // 1) 개시 코드 (Cmaj) - 짧게
        poly.triggerAttackRelease(["C5","E5","G5"], "8n", t);

        // 2) 아르페지오 런
        const arp = ["C5","E5","G5","B5","C6","E6","G6"];
        arp.forEach((n, i) => {
          lead.triggerAttackRelease(n, "16n", t + 0.15 + i*0.09);
        });

        // 3) 글리산도 느낌의 빠른 상행(짧은 32분음표 느낌)
        const glide = ["G5","A5","B5","C6","D6","E6"];
        glide.forEach((n, i) => {
          lead.triggerAttackRelease(n, "32n", t + 0.85 + i*0.05);
        });

        // 4) 마지막 팡! (C/E/G/C 옥타브) 길게
        poly.triggerAttackRelease(["C5","E5","G5","C6"], "2n", t + 1.2);

        // 5) 작은 엔딩 트릴
        lead.triggerAttackRelease("E6","32n", t + 1.35);
        lead.triggerAttackRelease("D6","32n", t + 1.40);
        lead.triggerAttackRelease("E6","16n", t + 1.45);

        return;
      }

      // WebAudio: 비프 시퀀스 대체 (주요 음 높이만 재현)
      if (engine === 'web'){
        const C5=523.25, E5=659.25, G5=783.99, B5=987.77, C6=1046.5, E6=1318.5, G6=1568.0, A5=880, D6=1174.66;
        // 코드
        webBeep(C5,0.12,0.00); webBeep(E5,0.12,0.00); webBeep(G5,0.12,0.00);
        // 아르페지오
        [[C5,0.15],[E5,0.24],[G5,0.33],[B5,0.42],[C6,0.51],[E6,0.60],[G6,0.69]].forEach(([f,at])=>webBeep(f,0.10,at));
        // 글리산도 느낌
        [[G5,0.85],[A5,0.90],[B5,0.95],[C6,1.00],[D6,1.05],[E6,1.10]].forEach(([f,at])=>webBeep(f,0.06,at));
        // 마지막 코드
        [[C5,1.20],[E5,1.20],[G5,1.20],[C6,1.20]].forEach(([f,at])=>webBeep(f,0.40,at));
        // 엔딩 트릴
        webBeep(E6,0.05,1.35); webBeep(D6,0.05,1.40); webBeep(E6,0.10,1.45);
        return;
      }

      // HTMLAudio: 짧은 비프를 여러 번
      [0,200,400,600,900,950,1000,1200,1350,1400,1450].forEach((ms,i)=>{
        setTimeout(()=>{ playHtmlBeepOnce(); }, ms);
      });
    }

    // 깜짝 사운드는 기존보다 조금 더 업(짧은 상행)
    function playSurpriseSound(){
      if (!audioInitialized) return;

      if (engine === 'tone' && lead){
        const t = Tone.now();
        ["C4","G4","C5","E5","G5"].forEach((n,i)=>{
          lead.triggerAttackRelease(n,"8n", t + i*0.18);
        });
        return;
      }
      if (engine === 'web'){
        const C4=261.63, G4=392.00, C5=523.25, E5=659.25, G5=783.99;
        [[C4,0],[G4,0.18],[C5,0.36],[E5,0.54],[G5,0.72]].forEach(([f,at])=>webBeep(f,0.16,at));
        return;
      }
      [0,180,360,540,720].forEach(ms=>setTimeout(()=>playHtmlBeepOnce(), ms));
    }

    // ===== Minimal-gesture Auto Unlock & Auto Start =====
    let firstInteractionDone = false;
    async function unlockAndMaybeAutoStart() {
      if (firstInteractionDone) return;
      firstInteractionDone = true;

      const ok = await initAudio();
      if (!ok) return;

      if (AUTO_START) {
        const tryStart = () => {
          const count = parseInt(studentCountInput.value);
          if (!isNaN(count) && count > 0) {
            startSpinning();
          } else {
            playWinnerFanfare();  // 자동시작 못하면 팬파레만
          }
        };
        setTimeout(tryStart, 300);
      } else {
        // 언락 피드백
        playWinnerFanfare();
      }
    }

    document.addEventListener('pointerdown', unlockAndMaybeAutoStart, { once:true, capture:true });
    document.addEventListener('keydown', unlockAndMaybeAutoStart, { once:true, capture:true });
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) unlockAndMaybeAutoStart();
    }, { once:true, capture:true });

    // ===== App Logic =====
    const characteristics = ["오늘 가장 일찍 등교한 사람","생일이 오늘 날짜와 가장 가까운 사람","어제 저녁으로 면 요리를 먹은 사람","어제 저녁으로 밥이 아닌 다른 것을 먹은 사람","반에서 머리가 가장 긴 사람","반에서 머리가 가장 짧은 사람","오늘 교과서를 안 가져온 사람","발 사이즈가 230mm 이하인 사람","발 사이즈가 270mm 이상인 사람","키가 180cm에 가장 가까운 사람","키가 150cm에 가장 가까운 사람","필통 속에 가장 긴 펜을 가진 사람","휴대폰 배경화면이 기본 이미지인 사람","맨 뒷줄 가운데 자리에 앉은 사람","오늘 파란색 계열 옷을 입은 사람","주머니에 동전이 있는 사람","이름이 4글자인 사람","오늘 아침 급식 메뉴를 기억하는 사람","어제 밤 11시 이전에 잠든 사람","오늘 아침에 우유를 마신 사람","학번이 홀수인 사람","학번이 짝수인 사람","신발끈이 없는 신발을 신은 사람","안경알이 동그란 사람","가방 색이 검은색이 아닌 사람","필통이 플라스틱 재질인 사람","손목시계를 차고 있는 사람","오늘 체육복을 입고 있는 사람","이름의 초성이 'ㅇ'으로 시작하는 사람","태어난 달이 12월인 사람","가장 최근에 영화를 본 사람","오늘 양말 색깔이 흰색이 아닌 사람","창가 쪽 맨 앞자리에 앉은 사람","복도 쪽 맨 뒷자리에 앉은 사람","형제, 자매가 없는 사람","반려동물을 키우는 사람","가장 좋아하는 과목이 역사인 사람","어제 음악을 들으며 등교한 사람","필통에 자가 없는 사람","휴대폰 배터리가 50% 이하인 사람","오늘 대중교통을 타고 온 사람","상의에 주머니가 없는 사람","가방에 책을 5권 이상 넣어온 사람","어제 운동을 한 사람","휴대폰 케이스가 투명한 사람","쉬는 시간에 잠을 잔 사람","오늘 입은 옷 소매가 가장 긴 사람","가장 최근에 필기한 글씨 색이 검은색이 아닌 사람","신발에 3가지 이상의 색이 들어간 사람","필통에 캐릭터 스티커가 붙어있는 사람"];
    const surprises = ["🎉 깜짝 간식 당첨! 🎉","✨ 칭찬 폭탄 타임! ✨","🌟 행운의 상점 당첨! 🌟","👏 모두의 큰 박수 당첨! 👏","🙌 모두의 큰 환호 당첨! 🙌"];

    async function startSpinning() {
      await initAudio();
      const count = parseInt(studentCountInput.value);
      if (isNaN(count) || count < 1) { errorMsg.textContent = "1 이상의 학생 수를 입력해주세요."; return; }
      errorMsg.textContent = "";
      isSpinning = true;
      startBtn.disabled = true; studentCountInput.disabled = true; stopBtn.disabled = false;
      intervalId = setInterval(() => { resultDiv.textContent = Math.floor(Math.random() * count) + 1; }, 50);
    }
    function stopSpinning() {
      if (!isSpinning) return;
      clearInterval(intervalId); isSpinning = false;
      startBtn.disabled = false; studentCountInput.disabled = false; stopBtn.disabled = true;

      if (Math.random() < 0.15) {
        const surprise = surprises[Math.floor(Math.random() * surprises.length)];
        switchToView('characteristic', surprise);
        playSurpriseSound();
      } else {
        resultDiv.classList.add('winner');
        // >>> 여기서 화려한 팬파레!
        playWinnerFanfare();
      }
      celebrateEffect();
    }
    async function startCharacteristicSpin() {
      await initAudio();
      if (isSpinning) return;
      isSpinning = true;
      pickCharacteristicBtn.disabled = false;
      pickCharacteristicBtn.textContent = "멈춤!";
      pickCharacteristicBtn.style.backgroundColor = 'var(--color-stop)';
      intervalId = setInterval(() => {
        const randomChar = characteristics[Math.floor(Math.random() * characteristics.length)];
        characteristicResultDiv.textContent = randomChar;
        characteristicResultDiv.classList.remove('winner');
      }, 80);
    }
    function stopCharacteristicSpin() {
      if (!isSpinning) return;
      clearInterval(intervalId); isSpinning = false;
      pickCharacteristicBtn.textContent = "다시 뽑기!";
      pickCharacteristicBtn.style.backgroundColor = 'var(--color-feature)';
      if (Math.random() < 0.15) {
        const surprise = surprises[Math.floor(Math.random() * surprises.length)];
        characteristicResultDiv.textContent = surprise;
        playSurpriseSound();
      } else {
        const chosen = characteristics[Math.floor(Math.random() * characteristics.length)];
        characteristicResultDiv.textContent = chosen;
        // >>> 특징도 당첨 사운드는 동일하게
        playWinnerFanfare();
      }
      characteristicResultDiv.classList.add('winner');
      celebrateEffect();
    }

    function celebrateEffect() {
      let flashCount = 0;
      if (celebrateIntervalId) clearInterval(celebrateIntervalId);
      celebrateIntervalId = setInterval(() => {
        displayArea.style.backgroundColor = (flashCount % 2 === 0) ? 'var(--bg-celebrate)' : 'var(--bg-display)';
        flashCount++;
        if (flashCount > 5) {
          clearInterval(celebrateIntervalId);
          displayArea.style.backgroundColor = 'var(--bg-display)';
        }
      }, 120);
    }
    function resetState() {
      if (intervalId) clearInterval(intervalId);
      if (celebrateIntervalId) clearInterval(celebrateIntervalId);
      displayArea.style.backgroundColor = 'var(--bg-display)';
      Object.values(displays).forEach(d => d.classList.remove('winner'));
      isSpinning = false;
      pickCharacteristicBtn.disabled = false;
    }
    function switchToView(mode, content = null) {
      resetState();
      Object.values(tabs).forEach(t => { t.style.color = '#94a3b8'; t.style.borderColor = 'transparent'; });
      Object.values(controls).forEach(c => c.classList.add('hidden'));
      Object.values(displays).forEach(d => d.classList.add('hidden'));
      const activeColor = `var(--color-${mode === 'characteristic' ? 'feature' : 'stop'})`;
      tabs[mode].style.color = activeColor;
      tabs[mode].style.borderColor = activeColor;
      controls[mode].classList.remove('hidden');
      displays[mode].classList.remove('hidden');
      if (mode === 'number') {
        resultDiv.textContent = '?';
        startBtn.disabled = false; stopBtn.disabled = true; studentCountInput.disabled = false;
      } else if (mode === 'characteristic') {
        if (content) {
          characteristicResultDiv.textContent = content;
          characteristicResultDiv.classList.add('winner');
          celebrateEffect();
          pickCharacteristicBtn.textContent = "다시 뽑기!";
          pickCharacteristicBtn.style.backgroundColor = 'var(--color-feature)';
        } else {
          startCharacteristicSpin();
        }
      }
    }

    // ===== Event wiring =====
    tabs.number.addEventListener('click', async ()=>{ await initAudio(); switchToView('number'); });
    tabs.characteristic.addEventListener('click', async ()=>{ await initAudio(); switchToView('characteristic'); });
    startBtn.addEventListener('click', async ()=>{ await initAudio(); startSpinning(); });
    stopBtn.addEventListener('click', async ()=>{ await initAudio(); stopSpinning(); });
    pickCharacteristicBtn.addEventListener('click', async ()=>{
      await initAudio();
      if (isSpinning) stopCharacteristicSpin(); else startCharacteristicSpin();
    });
    studentCountInput.addEventListener('keyup', async (e)=>{
      if (e.key === 'Enter'){ await initAudio(); startSpinning(); }
    });

    switchToView('number');
  });
  </script>
</body>
</html>


