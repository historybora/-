<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë‘ê·¼ë‘ê·¼ ë°œí‘œì ë½‘ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
  <style>
    :root{
      --bg-main:#FFFBF5;--bg-display:#FCEFEF;--bg-celebrate:#FFF2A1;
      --color-start:#4A90E2;--color-stop:#FF6B6B;--color-feature:#4ECDC4;
      --text-default:#333;--text-winner:#FF6B6B
    }
    body{font-family:'Gowun Dodum',sans-serif;background:var(--bg-main)}
    .result-display{font-weight:900;font-size:12rem;line-height:1;text-shadow:4px 4px 10px rgba(0,0,0,.08);color:var(--text-default);transition:color .3s}
    .characteristic-display{font-weight:700;font-size:2.5rem;line-height:1.4;text-shadow:2px 2px 6px rgba(0,0,0,.08);color:var(--text-default);transition:color .3s;word-break:keep-all}
    .winner{color:var(--text-winner)!important}
    .btn-primary{transition:.2s;box-shadow:0 4px 14px rgba(0,0,0,.1);border:none}
    .btn-primary:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.15)}
    .btn-primary:disabled{opacity:.7;cursor:not-allowed}
    @media (min-width:640px){.result-display{font-size:15rem}.characteristic-display{font-size:2.8rem}}
  </style>
</head>
<body class="text-slate-800 flex flex-col items-center justify-center min-h-screen p-4 antialiased">
  <div class="absolute top-4 right-4 text-xs text-slate-400">ë³´ë¼ìŒ¤ê³¼ ì—­ì‚¬ë¥¼ ë³´ë¼</div>

  <div class="w-full max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl shadow-rose-100 p-6 md:p-10 text-center">
    <h1 class="text-3xl sm:text-4xl font-bold text-slate-700 mb-2 whitespace-nowrap">ë‘ê·¼ë‘ê·¼ ë°œí‘œì ë½‘ê¸°</h1>
    <p class="text-slate-500 mb-6">ì˜¤ëŠ˜ì˜ í–‰ìš´ì˜ ì£¼ì¸ê³µì€ ëˆ„êµ¬ì¼ê¹Œìš”?</p>

    <div id="display-area" class="rounded-2xl min-h-[300px] md:min-h-[350px] flex items-center justify-center my-6 p-4"
         style="background-color: var(--bg-display); transition: background-color .1s ease;">
      <div id="result" class="result-display select-none">?</div>
      <div id="characteristic-result" class="characteristic-display select-none hidden px-4"></div>
    </div>

    <div>
      <div class="flex justify-center border-b border-rose-100 mb-6">
        <button id="tab-number" class="px-6 py-3 font-bold border-b-2 transition-colors">ë²ˆí˜¸</button>
        <button id="tab-characteristic" class="px-6 py-3 font-bold text-slate-400 transition-colors">íŠ¹ì§•</button>
      </div>

      <div id="number-picker-controls">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
          <div class="relative w-full sm:w-auto">
            <label for="student-count" class="absolute -top-2 left-2 inline-block bg-white px-1 text-xs font-medium text-slate-500">ì´ í•™ìƒ ìˆ˜</label>
            <input type="number" id="student-count" min="1" class="w-full sm:w-48 text-center text-lg px-4 py-3 rounded-xl border border-slate-300 focus:ring-2"
                   style="--tw-ring-color: var(--color-start); border-color: var(--color-start);">
          </div>
          <button id="start-btn" class="w-full sm:w-auto text-lg font-bold text-white px-8 py-3 rounded-xl btn-primary" style="background-color: var(--color-start);">ì‹œì‘</button>
          <button id="stop-btn" class="w-full sm:w-auto text-lg font-bold text-white px-8 py-3 rounded-xl btn-primary" style="background-color: var(--color-stop);" disabled>ë©ˆì¶¤!</button>
        </div>
        <p id="error-msg" class="text-red-500 h-6 mt-2 text-sm"></p>
      </div>

      <div id="characteristic-picker-controls" class="hidden">
        <button id="pick-characteristic-btn" class="w-full sm:w-auto text-lg font-bold text-white px-10 py-4 rounded-xl btn-primary"
                style="background-color: var(--color-feature);">ë‹¤ì‹œ ë½‘ê¸°!</button>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // ===== DOM refs =====
    const resultDiv = document.getElementById('result');
    const studentCountInput = document.getElementById('student-count');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const errorMsg = document.getElementById('error-msg');
    const displayArea = document.getElementById('display-area');
    const characteristicResultDiv = document.getElementById('characteristic-result');
    const pickCharacteristicBtn = document.getElementById('pick-characteristic-btn');
    const tabs = { number: document.getElementById('tab-number'), characteristic: document.getElementById('tab-characteristic') };
    const controls = { number: document.getElementById('number-picker-controls'), characteristic: document.getElementById('characteristic-picker-controls') };
    const displays = { number: resultDiv, characteristic: characteristicResultDiv };

    // ===== state =====
    let intervalId = null, celebrateIntervalId = null, isSpinning = false;
    let audioInitialized = false;
    let engine = null;          // 'tone' | 'web' | 'html'
    // Tone chain
    let poly = null;            // Tone.PolySynth
    let lead = null;            // Tone.Synth (lead)
    let rev = null, chorus = null; // effects
    // WebAudio fallback
    let webCtx = null, webGain = null;

    // URL ì˜µì…˜: ?auto=1 â†’ ì–¸ë½ ì§í›„ ìë™ "ì‹œì‘"
    const params = new URLSearchParams(location.search);
    const AUTO_START = params.get('auto') === '1';

    // HTMLAudio í´ë°±ìš© ì´ˆë¯¸ë‹ˆ ë¹„í”„ wav (data URI)
    const beepData = "data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAACABAAZGF0YQgAAAABAQEBBQQGBwgICQkKCwsMDQ4PEBESExQVFhcY";
    const audioEl = new Audio(beepData); audioEl.preload = "auto"; audioEl.playsInline = true;

    // ===== Audio Init: triple fallback =====
    async function initAudio() {
      if (audioInitialized) return true;

      // 1) Tone.js
      try {
        if (typeof Tone !== 'undefined') {
          await Tone.start();
          await Tone.context.resume();

          // Effects
          rev = new Tone.Reverb({ decay: 2.2, wet: 0.25 });
          chorus = new Tone.Chorus({ frequency: 4, delayTime: 2.5, depth: 0.3, wet: 0.2 }).start();

          // Instruments
          poly = new Tone.PolySynth(Tone.Synth, {
            oscillator:{ type:'triangle8' },
            envelope:{ attack:0.005, decay:0.2, sustain:0.3, release:0.9 }
          });
          lead = new Tone.Synth({
            oscillator:{ type:'sawtooth' },
            envelope:{ attack:0.005, decay:0.15, sustain:0.2, release:0.4 }
          });

          // Routing
          poly.connect(chorus);
          chorus.connect(rev);
          rev.toDestination();
          lead.connect(rev);

          engine = 'tone';
          audioInitialized = true;
          return true;
        }
      } catch (e) {
        console.warn('Tone init failed:', e);
      }

      // 2) WebAudio Oscillator
      try {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) throw new Error('AudioContext not supported');
        webCtx = new Ctx();
        if (webCtx.state !== 'running') await webCtx.resume();
        webGain = webCtx.createGain();
        webGain.gain.value = 0.25;
        webGain.connect(webCtx.destination);
        engine = 'web';
        audioInitialized = true;
        return true;
      } catch (e) {
        console.warn('WebAudio init failed:', e);
      }

      // 3) HTMLAudio
      try {
        await audioEl.play().then(()=>audioEl.pause()).catch(()=>{});
        engine = 'html';
        audioInitialized = true;
        return true;
      } catch(e) {
        console.error('HTMLAudio init failed', e);
        return false;
      }
    }

    // === WebAudio helper ===
    function webBeep(freq=523.25, dur=0.15, when=0){
      if (!webCtx||!webGain) return;
      const t0 = webCtx.currentTime + when;
      const osc = webCtx.createOscillator();
      const g = webCtx.createGain();
      osc.type='sine'; osc.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(0.6, t0+0.01);
      g.gain.linearRampToValueAtTime(0.0, t0+dur);
      osc.connect(g); g.connect(webGain);
      osc.start(t0); osc.stop(t0+dur+0.02);
    }
    async function playHtmlBeepOnce(){ try { audioEl.currentTime = 0; await audioEl.play(); } catch(e) {} }

    // ====== ë©œë¡œë””(íŒ¬íŒŒë ˆ) ======
    // Tone.js: í™”ë ¤í•œ íŒ¬íŒŒë ˆ (ì•„ë¥´í˜ì§€ì˜¤ + ë§ˆê° ì½”ë“œ + ê¸€ë¦¬ì‚°ë„ ëŠë‚Œ)
    function playWinnerFanfare(){
      if (!audioInitialized) return;

      if (engine === 'tone' && poly && lead){
        const t = Tone.now();

        // 1) ê°œì‹œ ì½”ë“œ (Cmaj) - ì§§ê²Œ
        poly.triggerAttackRelease(["C5","E5","G5"], "8n", t);

        // 2) ì•„ë¥´í˜ì§€ì˜¤ ëŸ°
        const arp = ["C5","E5","G5","B5","C6","E6","G6"];
        arp.forEach((n, i) => {
          lead.triggerAttackRelease(n, "16n", t + 0.15 + i*0.09);
        });

        // 3) ê¸€ë¦¬ì‚°ë„ ëŠë‚Œì˜ ë¹ ë¥¸ ìƒí–‰(ì§§ì€ 32ë¶„ìŒí‘œ ëŠë‚Œ)
        const glide = ["G5","A5","B5","C6","D6","E6"];
        glide.forEach((n, i) => {
          lead.triggerAttackRelease(n, "32n", t + 0.85 + i*0.05);
        });

        // 4) ë§ˆì§€ë§‰ íŒ¡! (C/E/G/C ì˜¥íƒ€ë¸Œ) ê¸¸ê²Œ
        poly.triggerAttackRelease(["C5","E5","G5","C6"], "2n", t + 1.2);

        // 5) ì‘ì€ ì—”ë”© íŠ¸ë¦´
        lead.triggerAttackRelease("E6","32n", t + 1.35);
        lead.triggerAttackRelease("D6","32n", t + 1.40);
        lead.triggerAttackRelease("E6","16n", t + 1.45);

        return;
      }

      // WebAudio: ë¹„í”„ ì‹œí€€ìŠ¤ ëŒ€ì²´ (ì£¼ìš” ìŒ ë†’ì´ë§Œ ì¬í˜„)
      if (engine === 'web'){
        const C5=523.25, E5=659.25, G5=783.99, B5=987.77, C6=1046.5, E6=1318.5, G6=1568.0, A5=880, D6=1174.66;
        // ì½”ë“œ
        webBeep(C5,0.12,0.00); webBeep(E5,0.12,0.00); webBeep(G5,0.12,0.00);
        // ì•„ë¥´í˜ì§€ì˜¤
        [[C5,0.15],[E5,0.24],[G5,0.33],[B5,0.42],[C6,0.51],[E6,0.60],[G6,0.69]].forEach(([f,at])=>webBeep(f,0.10,at));
        // ê¸€ë¦¬ì‚°ë„ ëŠë‚Œ
        [[G5,0.85],[A5,0.90],[B5,0.95],[C6,1.00],[D6,1.05],[E6,1.10]].forEach(([f,at])=>webBeep(f,0.06,at));
        // ë§ˆì§€ë§‰ ì½”ë“œ
        [[C5,1.20],[E5,1.20],[G5,1.20],[C6,1.20]].forEach(([f,at])=>webBeep(f,0.40,at));
        // ì—”ë”© íŠ¸ë¦´
        webBeep(E6,0.05,1.35); webBeep(D6,0.05,1.40); webBeep(E6,0.10,1.45);
        return;
      }

      // HTMLAudio: ì§§ì€ ë¹„í”„ë¥¼ ì—¬ëŸ¬ ë²ˆ
      [0,200,400,600,900,950,1000,1200,1350,1400,1450].forEach((ms,i)=>{
        setTimeout(()=>{ playHtmlBeepOnce(); }, ms);
      });
    }

    // ê¹œì§ ì‚¬ìš´ë“œëŠ” ê¸°ì¡´ë³´ë‹¤ ì¡°ê¸ˆ ë” ì—…(ì§§ì€ ìƒí–‰)
    function playSurpriseSound(){
      if (!audioInitialized) return;

      if (engine === 'tone' && lead){
        const t = Tone.now();
        ["C4","G4","C5","E5","G5"].forEach((n,i)=>{
          lead.triggerAttackRelease(n,"8n", t + i*0.18);
        });
        return;
      }
      if (engine === 'web'){
        const C4=261.63, G4=392.00, C5=523.25, E5=659.25, G5=783.99;
        [[C4,0],[G4,0.18],[C5,0.36],[E5,0.54],[G5,0.72]].forEach(([f,at])=>webBeep(f,0.16,at));
        return;
      }
      [0,180,360,540,720].forEach(ms=>setTimeout(()=>playHtmlBeepOnce(), ms));
    }

    // ===== Minimal-gesture Auto Unlock & Auto Start =====
    let firstInteractionDone = false;
    async function unlockAndMaybeAutoStart() {
      if (firstInteractionDone) return;
      firstInteractionDone = true;

      const ok = await initAudio();
      if (!ok) return;

      if (AUTO_START) {
        const tryStart = () => {
          const count = parseInt(studentCountInput.value);
          if (!isNaN(count) && count > 0) {
            startSpinning();
          } else {
            playWinnerFanfare();  // ìë™ì‹œì‘ ëª»í•˜ë©´ íŒ¬íŒŒë ˆë§Œ
          }
        };
        setTimeout(tryStart, 300);
      } else {
        // ì–¸ë½ í”¼ë“œë°±
        playWinnerFanfare();
      }
    }

    document.addEventListener('pointerdown', unlockAndMaybeAutoStart, { once:true, capture:true });
    document.addEventListener('keydown', unlockAndMaybeAutoStart, { once:true, capture:true });
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) unlockAndMaybeAutoStart();
    }, { once:true, capture:true });

    // ===== App Logic =====
    const characteristics = ["ì˜¤ëŠ˜ ê°€ì¥ ì¼ì° ë“±êµí•œ ì‚¬ëŒ","ìƒì¼ì´ ì˜¤ëŠ˜ ë‚ ì§œì™€ ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ëŒ","ì–´ì œ ì €ë…ìœ¼ë¡œ ë©´ ìš”ë¦¬ë¥¼ ë¨¹ì€ ì‚¬ëŒ","ì–´ì œ ì €ë…ìœ¼ë¡œ ë°¥ì´ ì•„ë‹Œ ë‹¤ë¥¸ ê²ƒì„ ë¨¹ì€ ì‚¬ëŒ","ë°˜ì—ì„œ ë¨¸ë¦¬ê°€ ê°€ì¥ ê¸´ ì‚¬ëŒ","ë°˜ì—ì„œ ë¨¸ë¦¬ê°€ ê°€ì¥ ì§§ì€ ì‚¬ëŒ","ì˜¤ëŠ˜ êµê³¼ì„œë¥¼ ì•ˆ ê°€ì ¸ì˜¨ ì‚¬ëŒ","ë°œ ì‚¬ì´ì¦ˆê°€ 230mm ì´í•˜ì¸ ì‚¬ëŒ","ë°œ ì‚¬ì´ì¦ˆê°€ 270mm ì´ìƒì¸ ì‚¬ëŒ","í‚¤ê°€ 180cmì— ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ëŒ","í‚¤ê°€ 150cmì— ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ëŒ","í•„í†µ ì†ì— ê°€ì¥ ê¸´ íœì„ ê°€ì§„ ì‚¬ëŒ","íœ´ëŒ€í° ë°°ê²½í™”ë©´ì´ ê¸°ë³¸ ì´ë¯¸ì§€ì¸ ì‚¬ëŒ","ë§¨ ë’·ì¤„ ê°€ìš´ë° ìë¦¬ì— ì•‰ì€ ì‚¬ëŒ","ì˜¤ëŠ˜ íŒŒë€ìƒ‰ ê³„ì—´ ì˜·ì„ ì…ì€ ì‚¬ëŒ","ì£¼ë¨¸ë‹ˆì— ë™ì „ì´ ìˆëŠ” ì‚¬ëŒ","ì´ë¦„ì´ 4ê¸€ìì¸ ì‚¬ëŒ","ì˜¤ëŠ˜ ì•„ì¹¨ ê¸‰ì‹ ë©”ë‰´ë¥¼ ê¸°ì–µí•˜ëŠ” ì‚¬ëŒ","ì–´ì œ ë°¤ 11ì‹œ ì´ì „ì— ì ë“  ì‚¬ëŒ","ì˜¤ëŠ˜ ì•„ì¹¨ì— ìš°ìœ ë¥¼ ë§ˆì‹  ì‚¬ëŒ","í•™ë²ˆì´ í™€ìˆ˜ì¸ ì‚¬ëŒ","í•™ë²ˆì´ ì§ìˆ˜ì¸ ì‚¬ëŒ","ì‹ ë°œëˆì´ ì—†ëŠ” ì‹ ë°œì„ ì‹ ì€ ì‚¬ëŒ","ì•ˆê²½ì•Œì´ ë™ê·¸ë€ ì‚¬ëŒ","ê°€ë°© ìƒ‰ì´ ê²€ì€ìƒ‰ì´ ì•„ë‹Œ ì‚¬ëŒ","í•„í†µì´ í”Œë¼ìŠ¤í‹± ì¬ì§ˆì¸ ì‚¬ëŒ","ì†ëª©ì‹œê³„ë¥¼ ì°¨ê³  ìˆëŠ” ì‚¬ëŒ","ì˜¤ëŠ˜ ì²´ìœ¡ë³µì„ ì…ê³  ìˆëŠ” ì‚¬ëŒ","ì´ë¦„ì˜ ì´ˆì„±ì´ 'ã…‡'ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì‚¬ëŒ","íƒœì–´ë‚œ ë‹¬ì´ 12ì›”ì¸ ì‚¬ëŒ","ê°€ì¥ ìµœê·¼ì— ì˜í™”ë¥¼ ë³¸ ì‚¬ëŒ","ì˜¤ëŠ˜ ì–‘ë§ ìƒ‰ê¹”ì´ í°ìƒ‰ì´ ì•„ë‹Œ ì‚¬ëŒ","ì°½ê°€ ìª½ ë§¨ ì•ìë¦¬ì— ì•‰ì€ ì‚¬ëŒ","ë³µë„ ìª½ ë§¨ ë’·ìë¦¬ì— ì•‰ì€ ì‚¬ëŒ","í˜•ì œ, ìë§¤ê°€ ì—†ëŠ” ì‚¬ëŒ","ë°˜ë ¤ë™ë¬¼ì„ í‚¤ìš°ëŠ” ì‚¬ëŒ","ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ê³¼ëª©ì´ ì—­ì‚¬ì¸ ì‚¬ëŒ","ì–´ì œ ìŒì•…ì„ ë“¤ìœ¼ë©° ë“±êµí•œ ì‚¬ëŒ","í•„í†µì— ìê°€ ì—†ëŠ” ì‚¬ëŒ","íœ´ëŒ€í° ë°°í„°ë¦¬ê°€ 50% ì´í•˜ì¸ ì‚¬ëŒ","ì˜¤ëŠ˜ ëŒ€ì¤‘êµí†µì„ íƒ€ê³  ì˜¨ ì‚¬ëŒ","ìƒì˜ì— ì£¼ë¨¸ë‹ˆê°€ ì—†ëŠ” ì‚¬ëŒ","ê°€ë°©ì— ì±…ì„ 5ê¶Œ ì´ìƒ ë„£ì–´ì˜¨ ì‚¬ëŒ","ì–´ì œ ìš´ë™ì„ í•œ ì‚¬ëŒ","íœ´ëŒ€í° ì¼€ì´ìŠ¤ê°€ íˆ¬ëª…í•œ ì‚¬ëŒ","ì‰¬ëŠ” ì‹œê°„ì— ì ì„ ì” ì‚¬ëŒ","ì˜¤ëŠ˜ ì…ì€ ì˜· ì†Œë§¤ê°€ ê°€ì¥ ê¸´ ì‚¬ëŒ","ê°€ì¥ ìµœê·¼ì— í•„ê¸°í•œ ê¸€ì”¨ ìƒ‰ì´ ê²€ì€ìƒ‰ì´ ì•„ë‹Œ ì‚¬ëŒ","ì‹ ë°œì— 3ê°€ì§€ ì´ìƒì˜ ìƒ‰ì´ ë“¤ì–´ê°„ ì‚¬ëŒ","í•„í†µì— ìºë¦­í„° ìŠ¤í‹°ì»¤ê°€ ë¶™ì–´ìˆëŠ” ì‚¬ëŒ"];
    const surprises = ["ğŸ‰ ê¹œì§ ê°„ì‹ ë‹¹ì²¨! ğŸ‰","âœ¨ ì¹­ì°¬ í­íƒ„ íƒ€ì„! âœ¨","ğŸŒŸ í–‰ìš´ì˜ ìƒì  ë‹¹ì²¨! ğŸŒŸ","ğŸ‘ ëª¨ë‘ì˜ í° ë°•ìˆ˜ ë‹¹ì²¨! ğŸ‘","ğŸ™Œ ëª¨ë‘ì˜ í° í™˜í˜¸ ë‹¹ì²¨! ğŸ™Œ"];

    async function startSpinning() {
      await initAudio();
      const count = parseInt(studentCountInput.value);
      if (isNaN(count) || count < 1) { errorMsg.textContent = "1 ì´ìƒì˜ í•™ìƒ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }
      errorMsg.textContent = "";
      isSpinning = true;
      startBtn.disabled = true; studentCountInput.disabled = true; stopBtn.disabled = false;
      intervalId = setInterval(() => { resultDiv.textContent = Math.floor(Math.random() * count) + 1; }, 50);
    }
    function stopSpinning() {
      if (!isSpinning) return;
      clearInterval(intervalId); isSpinning = false;
      startBtn.disabled = false; studentCountInput.disabled = false; stopBtn.disabled = true;

      if (Math.random() < 0.15) {
        const surprise = surprises[Math.floor(Math.random() * surprises.length)];
        switchToView('characteristic', surprise);
        playSurpriseSound();
      } else {
        resultDiv.classList.add('winner');
        // >>> ì—¬ê¸°ì„œ í™”ë ¤í•œ íŒ¬íŒŒë ˆ!
        playWinnerFanfare();
      }
      celebrateEffect();
    }
    async function startCharacteristicSpin() {
      await initAudio();
      if (isSpinning) return;
      isSpinning = true;
      pickCharacteristicBtn.disabled = false;
      pickCharacteristicBtn.textContent = "ë©ˆì¶¤!";
      pickCharacteristicBtn.style.backgroundColor = 'var(--color-stop)';
      intervalId = setInterval(() => {
        const randomChar = characteristics[Math.floor(Math.random() * characteristics.length)];
        characteristicResultDiv.textContent = randomChar;
        characteristicResultDiv.classList.remove('winner');
      }, 80);
    }
    function stopCharacteristicSpin() {
      if (!isSpinning) return;
      clearInterval(intervalId); isSpinning = false;
      pickCharacteristicBtn.textContent = "ë‹¤ì‹œ ë½‘ê¸°!";
      pickCharacteristicBtn.style.backgroundColor = 'var(--color-feature)';
      if (Math.random() < 0.15) {
        const surprise = surprises[Math.floor(Math.random() * surprises.length)];
        characteristicResultDiv.textContent = surprise;
        playSurpriseSound();
      } else {
        const chosen = characteristics[Math.floor(Math.random() * characteristics.length)];
        characteristicResultDiv.textContent = chosen;
        // >>> íŠ¹ì§•ë„ ë‹¹ì²¨ ì‚¬ìš´ë“œëŠ” ë™ì¼í•˜ê²Œ
        playWinnerFanfare();
      }
      characteristicResultDiv.classList.add('winner');
      celebrateEffect();
    }

    function celebrateEffect() {
      let flashCount = 0;
      if (celebrateIntervalId) clearInterval(celebrateIntervalId);
      celebrateIntervalId = setInterval(() => {
        displayArea.style.backgroundColor = (flashCount % 2 === 0) ? 'var(--bg-celebrate)' : 'var(--bg-display)';
        flashCount++;
        if (flashCount > 5) {
          clearInterval(celebrateIntervalId);
          displayArea.style.backgroundColor = 'var(--bg-display)';
        }
      }, 120);
    }
    function resetState() {
      if (intervalId) clearInterval(intervalId);
      if (celebrateIntervalId) clearInterval(celebrateIntervalId);
      displayArea.style.backgroundColor = 'var(--bg-display)';
      Object.values(displays).forEach(d => d.classList.remove('winner'));
      isSpinning = false;
      pickCharacteristicBtn.disabled = false;
    }
    function switchToView(mode, content = null) {
      resetState();
      Object.values(tabs).forEach(t => { t.style.color = '#94a3b8'; t.style.borderColor = 'transparent'; });
      Object.values(controls).forEach(c => c.classList.add('hidden'));
      Object.values(displays).forEach(d => d.classList.add('hidden'));
      const activeColor = `var(--color-${mode === 'characteristic' ? 'feature' : 'stop'})`;
      tabs[mode].style.color = activeColor;
      tabs[mode].style.borderColor = activeColor;
      controls[mode].classList.remove('hidden');
      displays[mode].classList.remove('hidden');
      if (mode === 'number') {
        resultDiv.textContent = '?';
        startBtn.disabled = false; stopBtn.disabled = true; studentCountInput.disabled = false;
      } else if (mode === 'characteristic') {
        if (content) {
          characteristicResultDiv.textContent = content;
          characteristicResultDiv.classList.add('winner');
          celebrateEffect();
          pickCharacteristicBtn.textContent = "ë‹¤ì‹œ ë½‘ê¸°!";
          pickCharacteristicBtn.style.backgroundColor = 'var(--color-feature)';
        } else {
          startCharacteristicSpin();
        }
      }
    }

    // ===== Event wiring =====
    tabs.number.addEventListener('click', async ()=>{ await initAudio(); switchToView('number'); });
    tabs.characteristic.addEventListener('click', async ()=>{ await initAudio(); switchToView('characteristic'); });
    startBtn.addEventListener('click', async ()=>{ await initAudio(); startSpinning(); });
    stopBtn.addEventListener('click', async ()=>{ await initAudio(); stopSpinning(); });
    pickCharacteristicBtn.addEventListener('click', async ()=>{
      await initAudio();
      if (isSpinning) stopCharacteristicSpin(); else startCharacteristicSpin();
    });
    studentCountInput.addEventListener('keyup', async (e)=>{
      if (e.key === 'Enter'){ await initAudio(); startSpinning(); }
    });

    switchToView('number');
  });
  </script>
</body>
</html>


